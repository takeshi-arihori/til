# AWSコンテナ設計・構築[本格]入門

## コンテナ技術を導入するために考慮すべきこと
- **コンテナを前提としたアプリケーション開発の在り方**
  分散システム構成になってしまうため、コンテナ間の疎結合性や移植性を考慮した方式を検討する必要がある。  
  コンテナのディスク領域は揮発性の打雨コンテナ破棄と同時に内部データは削除されてしまう。
  [The Twelve-Factor App](https://12factor.net/ja/)
  
- **コンテナ設計・運用に取り組む際の姿勢**
  レジストリ上のイメージに関するライフサイクル管理やイメージ野保護など、新たな運用が発生。
  ビルドからデプロイまでの流れや、コンテナオーケストレーション自体の権限制御、定義管理、セキュリティ設定等など。
  
## アーキテクチャ構成例
### ECS on Fargate:  
Fargate上にECSのタスクを起動してタスク上でコンテナを稼働させる
- **コスト:**
  vCPUとメモリリソース -> コンテナイメージを取得した時点からECSタスクが終了するまでを対象として計算される  
  インフラ管理の保守管理コストから解放される。  
  デプロイは比較的遅い。(コンテナごとにENIがアタッチされる、イメージキャッシュができない)  
  AWSマネージドなホストのため、基本的にはSSHログインはできない(`ECS Exec`でコンテナとの対話シェル、コマンドが実行可能に)  

### ビルディングブロックという思想

**ビルディングブロック**: AWSのサービス群をブロックのようにうまく組み合わせて利用すること  

![aws-container-basic drawio](https://github.com/user-attachments/assets/001f394f-3806-4de8-8026-9988e2910757)

## Well-Architectedフレームワークの活用
5つの設計原則
- **運用上の優秀性**
  - どのようにシステムの状態を把握するか
  - どのように不具合の修正を容易にするか
  - どのようにデプロイのリスクを軽減するか
- **セキュリティ**
  - クラウドセキュリティは最優先事項
- **信頼性**
  - 障害から自動的に復旧する
  - 復旧手順をテストする
  - 水平方向にスケールしてワークロード全体の可用性を高める
  - キャパシティを推測することをやめる
  - オートメーションで変更を管理する
- **パフォーマンス効率**
  - 高度なテクノロジーの民主化
  - わずか数分でグローバル展開する
  - サーバレスアーキテクチャを使用する
  - より頻繁に実験する
  - メカニカルシンパシーを重視する
- **コスト最適化**
  - クラウド財務管理を実践する
  - 消費モデルを導入する
  - 全体的な効率を測定する
  - 差別化につながらない高付加の作業に費用をかけるのをやめる
  - 費用を分析し帰属関係を明らかにする

### サンプルアプリの機能構成

![aws-container-basic-sec03 sample-application drawio](https://github.com/user-attachments/assets/4e142629-4601-4df9-bdc7-0b84b5271a2d)


### 設計で求められる要件と基本アーキテクチャ
- 多数の一般ユーザーに利用してもらうことを想定し、柔軟にスケール可能な構成にしたい
- 可用性を高めるためにマルチAZを基本構成としたい
- CI/CDパイプラインを構成し、アプリケーションリリースに対するアジリティを高めたい
- 各レイヤで適切なセキュリティ対策(不正アクセス対策、認証データの適切な管理、ログ保存、踏み台経由の内部アクセス等)を施したい

### AWS基本構成図

![aws-container-basic-sec03 sample-application-aws-diagram drawio](https://github.com/user-attachments/assets/bb11ea88-6129-4fbd-a5d1-ea8c8052f863)

**モニタリングの目的:** システムの可用性を維持するために問題発生に気づくこと(利用者に対してアプリケーションが利用可能な状態を維持するために行う)  
**オブザーバビリティ(可観測性):** システム全体を俯瞰しつつ、内部状態まで深堀りできるような状態  
**オブザーバビリティを獲得するために必要な要素:** 検知(メトリクス) -> 把握(トレース) -> 特定(ログ)  

### ロギング設計
- CLoudWatchによるログ運用
  シンプルなアプリケーションや大量ログが出力されないケース等
- FireLensによるログ運用
  CloudWatch以外のAWSサービスやAWS外のSaasへのログ転送がしやすい
  AWS推奨のログルーティング機能を担うソフトウェア -> Filuent Bit
  コンテナのデザインパターン -> サイドカー構成

### メトリクス設計
定量的な指標として定期的に計測・収集されるシステム内部動作のデータ  
ECSを利用する際にデフォルトで取得されるデータ  
- CPUUtilization
- MemoryuUtilization

**CLoudWatch Container Insights**: ECSタスクレベルでの情報把握とディスクやネットワークに関するメトリクスの収集  
- CPU
- メモリ
- ネットワーク
- ストレージ
- ECSタスク
- ECSサービス

### トレース設計
**X-Ray**: オブザーバビリティを実現するために、ログやメトリクス以外にアプリケーションの内部処理の呼び出しや各サービス間のトランザクション情報等のトレース情報を取得する必要がある。サービスマップのダッシュボードも提供されており、システム全体の可視化も合わせて実現可能。  

### CICD設計
ソフトウェア開発サイクルを早めることが重要 -> ビルドやテスト、デプロイ作業の自動化は開発サイクル高速化の手段   
変更を自動でリリースできるようになることで、今までビルドやデプロイに費やしていた時間をアプリケーション開発に集中させることができるようになる。  
**CI/CD:** ビルドやテスト、パッケージング、環境上へのデプロイといったソフトウェア開発サイクルを自動化、高速化するために用いられる手法  

