# MySQL における VARCHAR の定義について

※ ChatGPTで作成後未チェックのため注意

## **1. VARCHAR とは**
`VARCHAR` は、**可変長の文字列データ型** です。`CHAR` と異なり、格納するデータの長さに応じてストレージサイズが変わるため、メモリ効率が良くなります。

- **基本構文**
  ```sql
  column_name VARCHAR(N)
  ```
  - `N`: **最大文字数**（1～65,535まで設定可能。ただし、実際の最大値は行の制約による）

---

## **2. VARCHAR のストレージ要件**
`VARCHAR(N)` のストレージサイズは以下のように決まります。

1. **文字列のバイトサイズ**（エンコーディングに依存）
2. **追加オーバーヘッド**
   - **1バイト** の長さプレフィックス (`VARCHAR(1)～255`)
   - **2バイト** の長さプレフィックス (`VARCHAR(256)～65535`)

- **例: `VARCHAR(20)` に "Hello" を格納**
  - **UTF-8 (1文字 = 1バイトの場合)**  → **合計 6バイト**
  - **UTF-8 (絵文字などの3バイト文字含む場合)** → **合計 7バイト**

---

## **3. VARCHAR の最大長と制約**
### **3.1. 行の最大サイズの影響**
MySQL の 1 行の最大サイズは **65,535バイト**（約64KB）。ただし、エンコーディングの影響を受けます。

- **例: `VARCHAR(65535)` は実質不可能**
  - `utf8mb4` の場合、`N × 4バイト + 2バイト` の制限あり
  - 1 行に複数のカラムがあると `VARCHAR(65535)` は使えない

### **3.2. インデックス制約**
- **InnoDB では、インデックスに使える長さに制限あり**
  - `utf8mb4` では **最大3072バイトまで**
  - 長すぎる場合は **`TEXT` 型 + `FULLTEXT INDEX`** を使用

```sql
CREATE TABLE users (
    name VARCHAR(500),
    INDEX(name(100))  -- 最初の100文字のみインデックス
);
```

---

## **4. VARCHAR vs CHAR**
| 特性 | `VARCHAR(N)` | `CHAR(N)` |
|------|-------------|-----------|
| サイズ | **可変長**（Nバイト + 1 or 2バイト） | **固定長**（常にNバイト） |
| ストレージ効率 | **短い文字列では効率的** | **短い文字列だと無駄が多い** |
| パフォーマンス | **更新・挿入が多い場合に有利** | **検索時に有利（固定サイズなので速い）** |
| 末尾のスペース削除 | **される** | **されない** |

---

## **5. VARCHAR の適切なサイズ選び**

### **メモリアライメントを考慮する**
CPU のキャッシュ効率を考えると、**8の倍数** がメモリアライメント的に良い。

| 文字数 (`N`) | `utf8mb4` の最大バイト数 (`N × 4`) | 実際のストレージサイズ |
|-------------|---------------------------------|---------------------|
| `VARCHAR(8)`  | 32バイト  | 33バイト（+1バイトのプレフィックス） |
| `VARCHAR(16)` | 64バイト  | 65バイト（+1バイトのプレフィックス） |
| `VARCHAR(32)` | 128バイト | 129バイト（+1バイトのプレフィックス） |

✅ **小さな文字列なら `VARCHAR(8)`, `VARCHAR(16)`, `VARCHAR(32)` などを選ぶと良い**
✅ **長めのデータなら `VARCHAR(191)` に収める（それ以上なら `TEXT` を使う）**

---

## **6. VARCHAR(255) がよく使われる理由**

✅ **1バイトのプレフィックスで済む（`VARCHAR(256)` 以上だと2バイト）**  
✅ **インデックスのサイズ制限内に収まりやすい（特に `utf8mb4` では重要）**  
✅ **多くの一般的なデータ（名前、メール、URLなど）に対応できる汎用性**  
✅ **フレームワークやCMSでデフォルトの長さとして広く採用されている**  
✅ **将来的な拡張を考慮して安全な長さ**  

例: Laravel, Django, WordPress などでデフォルトとして `VARCHAR(255)` がよく使われる。

---

## **7. まとめ**
- **`VARCHAR(N)` の `N` は「文字数」であって「バイト数」ではない**
- **`utf8mb4` では最大 4バイト/文字 のため、サイズ選びに注意**
- **`VARCHAR(255)` はストレージ効率が良く、汎用性が高いためデフォルトでよく使われる**
- **`VARCHAR(191)` はインデックスの制限を考慮した最適な長さ**
- **8の倍数 (`VARCHAR(8)`, `VARCHAR(16)`, etc.) を選ぶとメモリアライメント的に有利**

適切な `VARCHAR` のサイズを選ぶことで、**ストレージ効率やパフォーマンスを向上させることができる**！

